FROM mwaaas/node-nginx:5.11.0-1.8.1-1

RUN npm install -g angular-cli && npm install -g --save process-nextick-args

# Fix bug https://github.com/npm/npm/issues/9863
RUN cd $(npm root -g)/npm \
  && npm install fs-extra \
  && sed -i -e s/graceful-fs/fs-extra/ -e s/fs\.rename/fs.move/ ./lib/utils/rename.js

COPY package.json /usr/packages/
RUN npm install --unsafe-perm=true

ONBUILD COPY . /usr/src/app

ONBUILD RUN [ -f ./package.json ] && | cp /usr/src/app/package.json /usr/packages/ && npm install --unsafe-perm=true | echo "package.json file not found"

ONBUILD RUN ng build --prod --env=prod

EXPOSE 80 49153

# configure nginx if there is a custom configuration
ONBUILD RUN [ -f ./nginx.conf ] && cp  /usr/src/app/nginx.conf  /etc/nginx/nginx.conf | echo "nginx  file not found"

# Link node modules
RUN ln /usr/packages/node_modules /usr/src/app/node_modules
